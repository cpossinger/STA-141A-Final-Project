---
title: 'STA 141A Fall 2022: Final Project'
author: 'Camden Possinger, Christina, Sydney'
output:
  html_document:
    number_sections: yes
runtime: shiny
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  out.width = "100%",
  out.height = "100%",
  message = FALSE,
  warning = FALSE
)
```

Introduction and research question, Data description, Data visualization, Methodology, Results, Conclusion and discussion of the results;

# Introduction 

# Research Question

# Data Description

```{r}
library(readr)
library(purrr)
library(ggplot2)
library(broom)
library(skimr)
library(knitr)
library(car)
library(tidyr)
library(stringr)
library(plotly)
library(jtools)
library(broom)
library(dplyr)
library(kableExtra)
library(ggfortify)
library(fastDummies)


spotify_preprocess <- function() {
  c(
    "60s",
    "70s",
    "80s",
    "90s",
    "00s",
    "10s"
  ) %>%
    purrr::set_names() %>%
    map(~ read_csv(paste0("dataset-of-", .x, ".csv"),
      show_col_types = FALSE
    )) %>%
    bind_rows(.id = "decade") %>%
    dplyr::select(-uri, -artist, -track) %>%
    mutate(
      key = factor(key),
      mode = factor(mode),
      time_signature = factor(time_signature),
      decade = factor(decade, levels = c("60s", "70s", "80s", "90s", "00s", "10s")),
      target = factor(target)
    ) %>%
    group_by(decade) %>%
    group_split() %>%
    map(~
      .x %>%
        mutate(across(
          where(is.numeric),
          ~ ifelse(
            abs(as.numeric(scale(.x))) > 3,
            NA,
            .x
          )
        )) %>%
        na.omit()) %>%
    bind_rows() %>%
    dummy_cols(
      select_columns = c("key", "time_signature", "mode"),
      remove_selected_columns = TRUE,
      remove_first_dummy = TRUE
    ) %>%
    mutate_if(is.integer, as.factor) %>%
    group_by(decade)
}
```

# Data Visualization 

```{r}
spotify_preprocess() %>%
  filter(target == 1) %>%
  select(where(is.numeric)) %>%
  skim() %>%
  focus(
    decade,
    numeric.mean,
    numeric.sd,
    numeric.hist
  ) %>%
  select(-skim_type) %>%
  setNames(c("Covariate", "Decade", "Mean", "SD", "Hist")) %>%
  mutate(
    Mean = round(Mean, digits = 2),
    SD = round(SD, digits = 2)
  ) %>%
  kbl() %>%
  kable_material() %>%
  scroll_box(width = "100%", height = "700px")
```

```{r}
ggplotly(spotify_preprocess() %>%
  filter(target == 1) %>%
  summarise(across(where(is.numeric), list(mean))) %>%
  pivot_longer(!decade, names_to = "feature", values_to = "mean") %>%
  mutate(feature = feature %>% str_remove("_1")) %>%
  ggplot(aes(x = mean, y = decade, fill = decade)) +
  geom_bar(stat = "identity") +
  facet_wrap(~feature, scales = "free_x")) %>%
  config(displayModeBar = FALSE) %>%
  layout(autosize = TRUE, height = 1000)
```

```{r}
ggplotly(spotify_preprocess() %>%
  filter(target == 1) %>%
  summarise(across(where(is.numeric), list(sd))) %>%
  pivot_longer(!decade, names_to = "feature", values_to = "sd") %>%
  mutate(feature = feature %>% str_remove("_1")) %>%
  ggplot(aes(x = sd, y = decade, fill = decade)) +
  geom_bar(stat = "identity") +
  facet_wrap(~feature, scales = "free_x")) %>%
  config(displayModeBar = FALSE) %>%
  layout(autosize = TRUE, height = 1000)
```


```{r}
ggplotly(spotify_preprocess() %>%
  filter(target == 1) %>%
  select(where(is.numeric)) %>%
  pivot_longer(!decade, names_to = "feature") %>%
  ggplot(aes(value, color = decade, fill = decade)) +
  geom_density(alpha = 0.2) +
  facet_wrap(~feature, scales = "free")) %>%
  config(displayModeBar = FALSE) %>%
  layout(autosize = TRUE, height = 1000)
```

```{r}
ggplotly(
  spotify_preprocess() %>%
    filter(target == 1) %>%
    select(where(is.factor), -target) %>%
    pivot_longer(!decade, names_to = "feature") %>%
    filter(value == 1) %>%
    mutate(value = as.integer(value)) %>%
    group_by(decade, feature) %>%
    summarise(sum = sum(value)) %>%
    ggplot(aes(x = sum, y = decade, color = decade, fill = decade)) +
    geom_bar(stat = "identity") +
    facet_wrap(~feature, scales = "free")
) %>%
  config(displayModeBar = FALSE) %>%
  layout(autosize = TRUE, height = 1000)
```




# Methodology

# Results

```{r}


# create_full_model <- function(df) {
#   glm(target ~ ., family = binomial(link = "logit"), data = df)
# }
#
# create_reduced_model <- function(df, coef) {
#   form <- paste0("target ~ ", paste0(coef, collapse = "+")) %>% as.formula()
#   glm(form, family = binomial(link = "logit"), data = df)
# }
#
# create_full_model(spotify_preprocess())
# spotify_preprocess()
#
# full_model <- spotify_preprocess() %>%
#   nest() %>%
#   mutate(
#     model = map(data, create_full_model),
#     summary = map(model, ~ .x %>% tidy(exponentiate = TRUE)),
#     vif = map(model, vif),
#     glance = map(model, glance),
#     sig_coef = map(summary, ~ .x %>%
#       filter(p.value <= 0.05, term != "(Intercept)") %>%
#       pull(term)),
#     reduced_model = map2(data, sig_coef, create_reduced_model)
#   )
#
# full_model %>%
#   pull(summary) %>%
#   bind_rows() %>%
#   kbl() %>%
#   kable_material() %>%
#   pack_rows("60s", 1, 29, label_row_css = "background-color: #666; color: #fff;") %>%
#   pack_rows("70s", 30, 57, label_row_css = "background-color: #666; color: #fff;") %>%
#   pack_rows("80s", 58, 85, label_row_css = "background-color: #666; color: #fff;") %>%
#   pack_rows("90s", 86, 113, label_row_css = "background-color: #666; color: #fff;") %>%
#   pack_rows("00s", 114, 142, label_row_css = "background-color: #666; color: #fff;") %>%
#   pack_rows("10s", 143, 171, label_row_css = "background-color: #666; color: #fff;") %>%
#   scroll_box(width = "100%", height = "700px")
```

```{r}



# reduced_model <- full_model %>%
#   dplyr::select(decade, data, model = reduced_model) %>%
#   mutate(
#     summary = map(model, ~ .x %>% tidy(exponentiate = TRUE)),
#     vif = map(model, vif),
#     glance = map(model, glance)
#   )
```

```{r}

# anova_lst <- map2(full_model$model, reduced_model$model, ~ anova(.x, .y, test = "LRT"))
#
#
# anova_lst[[1]]
# anova_lst[[2]]
# anova_lst[[3]]
# anova_lst[[4]]
# anova_lst[[5]]
# anova_lst[[6]]
#
# reduced_model$summary[[5]] %>% filter(p.value <= 0.05)
# full_model$summary[[5]]
#
# reduced_model$glance[[1]] %>% print(n = 28)
# full_model$glance[[1]] %>% print(n = 28)
#
#
# full_model$sig_coef[[2]]
# full_model$summary[[4]]
```


```{r}


# full_model$data[[2]] %>%
#   dplyr::select(where(is.numeric)) %>%
#   cbind(fitted = full_model$model[[2]]$fitted) %>%
#   pivot_longer(!fitted) %>%
#   ggplot(aes(y = fitted, x = value)) +
#   geom_point() +
#   facet_wrap(~name, scales = "free_x")
#
#
#
# full_model$model[[2]] %>% autoplot(which = 1:6)
```



# Conclusion

